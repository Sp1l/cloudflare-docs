{{- $files := $.Params.changelog_file_name -}}
{{- $changelogData := slice -}}
{{- $changelogDataEntries := slice -}}

{{- range $files -}}
{{- $changelogData = $changelogData | append (index (index $.Site.Data "changelogs") .) }}
{{- end -}}

{{- range $changelogData -}}
{{- $changelogDataEntries = $changelogDataEntries | append (index . "entries") }}
{{- end -}}

{{- $changelogDataEntries = sort $changelogDataEntries "publish_date" "desc" -}}

{{- $permalink := .Permalink -}}
{{- $atomLink := print $permalink "index.xml" -}}

{{- $product := default (index (index $changelogData 0) "productName") ($.Params.changelog_name) }}
{{- $mainTitle := printf "%s Â· %s" .Title $product -}}

<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>{{ $mainTitle }}</title>
    <link>{{ $permalink }}</link>
    <description>Updates to Cloudflare's {{$product}} product.</description>
    <language>en-us</language>
    <atom:link href="{{$atomLink}}" rel="self" />
    <lastBuildDate>{{- index (index $changelogDataEntries 0) "publish_date" | time.Format "Monday, Jan 2, 2006" -}}</lastBuildDate>
    {{- range $changelogDataEntries -}}
    {{- $entry := . -}}
    {{- $link := "" -}}
    {{- $title := "" -}}
    {{ $description := .description | $.Page.RenderString | htmlUnescape }}
    {{ $description = replaceRE `Open external link` "" $description -}}
    {{- with .title -}}
    {{- $link = print $permalink "#" (urlize .) -}}
    {{- $title = . -}}
    {{- else -}}
    {{- $link = print $permalink "#" (urlize .publish_date) -}}
    {{- $title = .publish_date -}}
    {{- end -}}
    {{- with .link -}}
    {{ $link = print "https://developers.cloudflare.com" . }}
    {{- end -}}
    {{- with .scheduled -}}
    {{ $title = print "Scheduled - " $title -}}
    {{ $description = printf "For more details, refer to the dedicated page for [%s scheduled changes - %s](%s)." $product $title $link | $.Page.RenderString | htmlUnescape -}}
    {{- end -}}
    <item>
    <title>{{- $title }}</title>
    <link>{{ $link }}</link>
    {{- with .table -}}
    {{- with $entry.scheduled -}}
    <description>{{ $description }}</description>
    {{- else -}}
    <description>
    <table>
    <thead>
    <tr>
    <th>Ruleset</th>
    <th>Rule ID</th>
    {{- if (eq $product "WAF") -}}
    <th>Legacy Rule ID</th>
    {{- end -}}
    <th>Description</th>
    <th>Previous Action</th>
    <th>New Action</th>
    <th>Comments</th>
    </tr>
    </thead>
    <tbody>
    {{- range index $entry "entries" -}}
    <tr>
    <td>{{- .ruleset -}}</td>
    <td>{{- .rule_id -}}</td>
    {{- if (eq $product "WAF") -}}
    <td>{{- .legacy_id -}}</td>
    {{- end -}}
    <td>{{- .description -}}</td>
    <td>{{- .previous_action -}}</td>
    <td>{{- .new_action -}}</td>
    <td>{{- .comments -}}</td>
    </tr>
    {{- end -}}
    </tbody>
    </table>
    </description>
    {{- end -}}
    {{- else -}}
    <description>{{ $description }}</description>
    {{- end -}}
    <pubDate>{{ .publish_date | time.Format "Monday, Jan 2, 2006" }}</pubDate>
    </item>
    {{- end -}}
  </channel>
</rss>